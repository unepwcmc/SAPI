<% if Rails.application.config_for(:analytics)[:ga_property_id] %>
  <!-- Google tag (gtag.js) -->
  <script
    async
    src="https://www.googletagmanager.com/gtag/js?id=<%=
      Rails.application.config_for(:analytics)[:ga_property_id]
    %>"
  ></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    window.ga_property_id = '<%= Rails.application.config_for(:analytics)[:ga_property_id] =%>';

    window.gtag = window.gtag || function() {
      window.dataLayer.push(arguments);
    }

    window.analytics.gtag = function () {
      if (window.gtag) {
        window.gtag.apply(window, arguments)
      } else {
        window.dataLayer.push(arguments);
        console.debug.apply(
          console,
          ['Google Analytics not initialised; called:\n'].concat(Array.from(arguments))
        )
      }
    }

    window.analytics.gtag('js', new Date());
    window.analytics.gtag('config', window.ga_property_id);
    window.analytics.gtag('consent', 'default', {
      'ad_storage': 'denied',
      'ad_user_data': 'denied',
      'ad_personalization': 'denied',
      'analytics_storage': 'denied'
    });

    window.analytics.rejectByProvider.ga = window.analytics.rejectByProvider.ga || function () {
      window.analytics.gtag('consent', 'update', {
        'ad_storage': 'denied',
        'ad_user_data': 'denied',
        'ad_personalization': 'denied',
        'analytics_storage': 'denied'
      });
    }

    window.analytics.loadByProvider.ga = window.analytics.loadByProvider.ga || function () {
      window.analytics.gtag('consent', 'update', {
        'ad_storage': 'denied',
        'ad_user_data': 'denied',
        'ad_personalization': 'denied',
        'analytics_storage': 'granted'
      });
    }
  </script>
<% else %>
  <script>
    window.analytics.ga = function (m, n, o, p, q) {
      console.debug(
        'Google Analytics not configured; called:\n', m, n, o, p, q
      )
    }
  </script>
<% end %>