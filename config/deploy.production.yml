# Name of the container image
image: ghcr.io/unepwcmc/sapi/rails-production

# Define services (servers for Kamal 2.5.2 compatibility)
servers:
  web:
    hosts:
      - example.com # TODO: Ruan
    proxy:
      hosts:
        - www.speciesplus.net # Public-facing domain
        # TODO: Ruan, do we need to add `speciesplus.net` (without www)?
      ssl: true # Proxy terminates SSL
      forward_headers: true # Forward headers like X-Forwarded-Proto
      healthcheck:
        path: /up
      logging:
        request_headers:
          - Cache-Control
          - User-Agent
          - X-Forwarded-Proto # Critical for Rails to detect HTTPS
        response_headers:
          - X-Request-ID
  job:
    hosts:
      - example.com # TODO: Ruan
    options:
      add-host: host.docker.internal:host-gateway
    cmd: bundle exec sidekiq -C config/sidekiq.yml
    healthcheck:
      cmd: /rails/bin/docker-sidekiq-healthcheck

# Environment variables
env:
  clear:
    RAILS_ENV: production
